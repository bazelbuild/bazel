common --enable_platform_specific_config

# Either consumed as @remoteapis or as files.
common --deleted_packages=third_party/remoteapis

# Shared configuration flags to build and test Bazel on RBE.
common:remote_shared --remote_instance_name=projects/bazel-untrusted/instances/default_instance
common:remote_shared --remote_executor=grpcs://remotebuildexecution.googleapis.com
common:remote_shared --remote_download_toplevel
common:remote_shared --remote_timeout=600
common:remote_shared --google_default_credentials
common:remote_shared --jobs=100
common:remote_shared --action_env=PATH=/bin:/usr/bin:/usr/local/bin

# Configuration to build and test Bazel on RBE on Ubuntu 20.04
common:ubuntu2004 --crosstool_top=@rbe_ubuntu2004//cc:toolchain
common:ubuntu2004 --extra_toolchains=@rbe_ubuntu2004//config:cc-toolchain
common:ubuntu2004 --extra_execution_platforms=//:rbe_ubuntu2004_platform,//:rbe_ubuntu2004_highcpu_platform
common:ubuntu2004 --host_platform=//:rbe_ubuntu2004_platform
common:ubuntu2004 --platforms=//:rbe_ubuntu2004_platform
common:ubuntu2004 --config=remote_shared

# Alias
common:remote --config=ubuntu2004

common:macos --host_macos_minimum_os=10.13
common:macos --macos_minimum_os=10.13

common:windows_arm64 --platforms=//:windows_arm64
common:windows_arm64 --extra_toolchains=@local_config_cc//:cc-toolchain-arm64_windows

# Check direct Bazel module dependencies are up-to-date
common --check_direct_dependencies=error

# Add mirrors for certain download URLs
common --downloader_config=bazel_downloader.cfg

# Add BCR module mirrors
common --module_mirrors=https://bcr.cloudflaremirrors.com

# Some integration tests need the PATH environment variable set.
common --test_env=PATH

# Suppress warnings from external repos, we have no direct control on them anyway.
common:linux --per_file_copt=external/.*@-w
common:linux --host_per_file_copt=external/.*@-w
common:macos --per_file_copt=external/.*@-w
common:macos --host_per_file_copt=external/.*@-w
common:windows --per_file_copt=external/.*@/w
common:windows --host_per_file_copt=external/.*@/w

# Enable Protobuf MSVC support on Windows
common:windows --define=protobuf_allow_msvc=true

# Enable Java 21 language features and compile for a Java 25 runtime, matching
# version of the embedded JDK.
# Keep in sync with //:java_toolchain_%d.
# LINT.IfChange
common --java_language_version=21
common --tool_java_language_version=21
common --java_runtime_version=remotejdk_25
common --tool_java_runtime_version=remotejdk_25
# LINT.ThenChange(//BUILD)
# Reduce the amount of warnings shown due to the deprecation of most Unsafe
# methods.
# TODO: Remove this after migrating more code to use VarHandles.
common --javacopt=-Xlint:-removal
common --host_javacopt=-Xlint:-removal
# Use a bootclasspath version matching the language version.
common --@rules_java//toolchains:incompatible_language_version_bootclasspath

# Fail if a classpath contains different versions of the same class
common --experimental_one_version_enforcement=ERROR

# User-specific .bazelrc
try-import %workspace%/user.bazelrc

common:docs --workspace_status_command=scripts/docs/get_workspace_status.sh

# Flags for CI builds
## Common
common:ci-common --lockfile_mode=error
common:ci-common --remote_download_minimal
common:ci-common --nobuild_runfile_links
common:ci-common --experimental_profile_include_target_label

## For Linux
common:ci-linux --config=ci-common
common:ci-linux --repository_cache=/var/lib/buildkite-agent/bazeltest/repo_cache
common:ci-linux --test_env=TEST_INSTALL_BASE=/var/lib/buildkite-agent/bazeltest/install_base
common:ci-linux --test_env=REPOSITORY_CACHE=/var/lib/buildkite-agent/bazeltest/repo_cache
common:ci-linux --test_env=REMOTE_NETWORK_ADDRESS=bazel.build:80
test:ci-linux --sandbox_writable_path=/var/lib/buildkite-agent/bazeltest
test:ci-linux --sandbox_default_allow_network=false

## For macOS
common:ci-macos --config=ci-common
common:ci-macos --repository_cache=/Users/buildkite/bazeltest/repo_cache
common:ci-macos --experimental_collect_system_network_usage
common:ci-macos --test_env=TEST_INSTALL_BASE=/Users/buildkite/bazeltest/install_base
common:ci-macos --test_env=REPOSITORY_CACHE=/Users/buildkite/bazeltest/repo_cache
common:ci-macos --test_env=REMOTE_NETWORK_ADDRESS=bazel.build:80
test:ci-macos --sandbox_writable_path=/Users/buildkite/bazeltest
# TODO(pcloudy): Revert to false once https://github.com/bazelbuild/bazel/issues/23726 is resolved.
test:ci-macos --sandbox_default_allow_network=true
common:ci-macos --test_tag_filters=-no_macos
common:ci-macos --experimental_async_execution
common:ci-macos --experimental_async_execution_max_concurrent_actions=0
common:ci-macos --jobs=100

## For Windows
common:ci-windows --config=ci-common
common:ci-windows --repository_cache=C:/b/bazeltest_repo_cache
common:ci-windows --test_env=BAZEL_VC
common:ci-windows --test_env=JAVA_HOME
common:ci-windows --test_env=TEST_INSTALL_BASE=C:/b/bazeltest_install_base
common:ci-windows --test_env=REPOSITORY_CACHE=C:/b/bazeltest_repo_cache
common:ci-windows --test_tag_filters=-no_windows,-slow
